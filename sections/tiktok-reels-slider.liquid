{% assign show_summary = section.settings.show_summary %}
{% assign view_mode = section.settings.view_mode %}
{% assign mode = section.settings.mode %}
{% assign mobile_columns = section.settings.mobile_columns | plus: 0 %}
{% assign tablet_columns = section.settings.tablet_columns | plus: 0 %}
{% assign desktop_columns = section.settings.desktop_columns | plus: 0 %}
{% assign grid_gap = section.settings.grid_gap | plus: 0 %}
<div class="tiktok-reels-section{% unless show_summary %} hide-summary{% endunless %}{% if view_mode == 'grid' %} grid-view{% endif %}{% if mode == 'dark' %} dark{% endif %}{% if mode == 'light' %} light{% endif %}">
  <h2 class="tiktok-reels-heading">{{ section.settings.title | default: '' }}</h2>
  
  {% if view_mode == 'slider' %}
    <!-- Slider View -->
    <div class="swiper tiktok-reels-swiper">
      <div class="swiper-wrapper">
        {% for block in section.blocks %}
          {% assign tiktok_url = block.settings.tiktok_url %}
          {% if tiktok_url contains '/video/' %}
            {% assign video_id = tiktok_url | split: '/video/' | last | split: '?' | first %}
            <div class="swiper-slide">
              <div class="tiktok-reel-embed-wrapper" data-video-id="{{ video_id }}">
                <div class="tiktok-loader"></div>
                <div class="tiktok-iframe-bg">
                  <blockquote class="tiktok-embed" cite="{{ tiktok_url | split: '?' | first }}" data-video-id="{{ video_id }}" style="max-width: 605px;min-width: 325px;">
                    <section> </section>
                  </blockquote>
                </div>
              </div>
            </div>
          {% endif %}
        {% endfor %}
      </div>
      <!-- Add Arrows -->
      <div class="swiper-button-next"></div>
      <div class="swiper-button-prev"></div>
      <!-- Add Pagination -->
      <div class="swiper-pagination"></div>
    </div>
  {% else %}
    <!-- Grid View -->
    <div class="tiktok-reels-grid">
      {% for block in section.blocks %}
        {% assign tiktok_url = block.settings.tiktok_url %}
        {% if tiktok_url contains '/video/' %}
          {% assign video_id = tiktok_url | split: '/video/' | last | split: '?' | first %}
          <div class="tiktok-reel-embed-wrapper" data-video-id="{{ video_id }}">
            <div class="tiktok-loader"></div>
            <div class="tiktok-iframe-bg">
              <blockquote class="tiktok-embed" cite="{{ tiktok_url | split: '?' | first }}" data-video-id="{{ video_id }}" style="max-width: 605px;min-width: 325px;">
                <section> </section>
              </blockquote>
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  {% endif %}
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.css" />
<script src="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Only initialize Swiper if slider view is active
  var swiperContainer = document.querySelector('.tiktok-reels-swiper');
  if (swiperContainer) {
    var swiper = new Swiper('.tiktok-reels-swiper', {
      slidesPerView: {{ mobile_columns }},
      spaceBetween: 20,
      loop: true,
      navigation: {
        nextEl: '.swiper-button-next',
        prevEl: '.swiper-button-prev',
      },
      pagination: {
        el: '.swiper-pagination',
        clickable: true,
      },
      autoplay: {
        delay: 3500,
        disableOnInteraction: false
      },
      breakpoints: {
        600: {
          slidesPerView: {{ tablet_columns }},
        },
        900: {
          slidesPerView: {{ desktop_columns }},
        }
      }
    });
    // Pause autoplay on mouse enter, resume on mouse leave
    var swiperEl = document.querySelector('.tiktok-reels-swiper');
    if (swiperEl) {
      swiperEl.addEventListener('mouseenter', function() {
        swiper.autoplay.stop();
      });
      swiperEl.addEventListener('mouseleave', function() {
        swiper.autoplay.start();
      });
    }
  }
  
  // Only add TikTok embed script if not already present
  if (!document.querySelector('script[src="https://www.tiktok.com/embed.js"]')) {
    var script = document.createElement('script');
    script.src = 'https://www.tiktok.com/embed.js';
    script.async = true;
    document.body.appendChild(script);
  }

  // Improved loader logic: Hide loader only after TikTok iframe is fully loaded
  document.querySelectorAll('.tiktok-reel-embed-wrapper').forEach(function(wrapper) {
    var observer = new MutationObserver(function(mutations, obs) {
      var iframe = wrapper.querySelector('iframe');
      if (iframe) {
        iframe.addEventListener('load', function() {
          var loader = wrapper.querySelector('.tiktok-loader');
          if (loader) loader.style.display = 'none';
        });
        // If iframe is already loaded (from cache), hide loader after a short delay
        if (iframe.complete) {
          setTimeout(function() {
            var loader = wrapper.querySelector('.tiktok-loader');
            if (loader) loader.style.display = 'none';
          }, 300);
        }
        obs.disconnect();
      }
    });
    observer.observe(wrapper, { childList: true, subtree: true });
  });
});
</script>

<style>
.tiktok-reels-section {
  padding: 40px 16px 32px 16px;
  border-radius: 16px;
  background: #fff;
  box-shadow: 0 2px 16px rgba(0,0,0,0.04);
  text-align: center;
  color: #181818;
}
.tiktok-reels-section.light {
  background: #fff;
  color: #181818;
}
.tiktok-reels-section.dark {
  background: #181818;
  color: #D3A640;
}
.tiktok-reels-heading {
  text-align: center;
  font-size: 2rem;
  margin-bottom: 0px;
  font-weight: 700;
  letter-spacing: 1px;
  color: var(--jdgm-heading, #181818);
}
.tiktok-reels-section.dark .tiktok-reels-heading {
  color: #D3A640;
}
.tiktok-reels-section.light .tiktok-reels-heading {
  color: #181818;
}
.tiktok-iframe-bg {
  background: #000;
  width: 100%;
  border-radius: 12px;
  padding: 0;
  display: flex;
  justify-content: center;
  align-items: center;
}
.tiktok-reels-section.dark .tiktok-iframe-bg {
  background: #fff;
}
.swiper-slide {
  display: flex;
  justify-content: center;
  align-items: center;
}
.tiktok-reel-embed-wrapper {
  position: relative;
  min-height: 400px;
  display: flex;
  justify-content: center;
  align-items: center;
}
.tiktok-loader {
  position: absolute;
  left: 50%;
  top: 50%;
  width: 48px;
  height: 48px;
  margin-left: -24px;
  margin-top: -24px;
  border: 5px solid #eee;
  border-top: 5px solid #D3A640;
  border-radius: 50%;
  animation: tiktok-spin 1s linear infinite;
  z-index: 2;
  background: transparent;
}
.tiktok-reels-section.dark .tiktok-loader {
  border: 5px solid #333;
  border-top: 5px solid #D3A640;
}
@keyframes tiktok-spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
/* Grid View Styles */
.tiktok-reels-grid {
  display: grid;
  gap: {{ grid_gap }}px;
  justify-items: center;
}
/* Mobile (default) */
.tiktok-reels-grid {
  grid-template-columns: repeat({{ mobile_columns }}, 1fr);
}
/* Tablet */
@media (min-width: 600px) {
  .tiktok-reels-grid {
    grid-template-columns: repeat({{ tablet_columns }}, 1fr);
  }
}
/* Desktop */
@media (min-width: 900px) {
  .tiktok-reels-grid {
    grid-template-columns: repeat({{ desktop_columns }}, 1fr);
  }
}
.tiktok-reels-section.grid-view .tiktok-reel-embed-wrapper {
  width: 100%;
}
@media (max-width: 600px) {
  .tiktok-reels-section {
    padding: 24px 4px 16px 4px;
  }
  .tiktok-reels-heading {
    font-size: 1.3rem;
    margin-bottom: 18px;
  }
}
</style>

{% schema %}
{
  "name": "TikTok Reels",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Section Title",
      "default": "Our TikTok Reels"
    },
    {
      "type": "select",
      "id": "view_mode",
      "label": "View Mode",
      "options": [
        { "value": "slider", "label": "Slider" },
        { "value": "grid", "label": "Grid" }
      ],
      "default": "slider"
    },
    {
      "type": "select",
      "id": "mobile_columns",
      "label": "Mobile Columns",
      "options": [
        { "value": "1", "label": "1 Column" },
        { "value": "2", "label": "2 Columns" },
        { "value": "3", "label": "3 Columns" },
        { "value": "4", "label": "4 Columns" }
      ],
      "default": "1"
    },
    {
      "type": "select",
      "id": "tablet_columns",
      "label": "Tablet Columns",
      "options": [
        { "value": "1", "label": "1 Column" },
        { "value": "2", "label": "2 Columns" },
        { "value": "3", "label": "3 Columns" },
        { "value": "4", "label": "4 Columns" }
      ],
      "default": "2"
    },
    {
      "type": "select",
      "id": "desktop_columns",
      "label": "Desktop Columns",
      "options": [
        { "value": "1", "label": "1 Column" },
        { "value": "2", "label": "2 Columns" },
        { "value": "3", "label": "3 Columns" },
        { "value": "4", "label": "4 Columns" }
      ],
      "default": "3"
    },
    {
      "type": "range",
      "id": "grid_gap",
      "label": "Grid Gap",
      "min": 10,
      "max": 50,
      "step": 5,
      "unit": "px",
      "default": 25
    },
    {
      "type": "select",
      "id": "mode",
      "label": "Color Mode",
      "options": [
        { "value": "light", "label": "Light" },
        { "value": "dark", "label": "Dark" }
      ],
      "default": "light"
    },
    {
      "type": "checkbox",
      "id": "show_summary",
      "label": "Show summary (stars and total reviews)",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "tiktok",
      "name": "TikTok Reel",
      "settings": [
        {
          "type": "text",
          "id": "tiktok_url",
          "label": "TikTok Video URL",
          "default": "https://www.tiktok.com/@tiktok/video/7137441234567890123"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "TikTok Reels"
    }
  ]
}
{% endschema %} 